<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartRide Helmet</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    .sidebar {
      width: 380px;
      background: white;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
      overflow-y: auto;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        max-height: 50vh;
      }
      body {
        flex-direction: column;
      }
    }

    .sidebar-content {
      padding: 24px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 24px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: bold;
      color: #1f2937;
    }

    .status-section {
      margin-bottom: 24px;
    }

    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .status-label {
      font-size: 14px;
      font-weight: 500;
      color: #6b7280;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-connected {
      background: #dcfce7;
      color: #166534;
    }

    .status-connecting {
      background: #fef3c7;
      color: #92400e;
    }

    .status-searching {
      background: #dbeafe;
      color: #1e40af;
    }

    .status-disconnected {
      background: #f3f4f6;
      color: #374151;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .info-card {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
    }

    .info-card-blue {
      background: #eff6ff;
    }

    .info-card-green {
      background: #f0fdf4;
    }

    .info-card-purple {
      background: #f5f3ff;
      border-left: 4px solid #8b5cf6;
    }

    .info-card-orange {
      background: #fff7ed;
      border-left: 4px solid #f59e0b;
    }

    .impact-alert {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 12px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .impact-alert:hover {
      background: #fee2e2;
    }

    .impact-alert-header {
      font-weight: 600;
      color: #991b1b;
      margin-bottom: 4px;
    }

    .impact-alert-details {
      color: #6b7280;
    }

    .info-card h2 {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .info-card p {
      font-size: 12px;
      color: #6b7280;
      margin: 4px 0;
    }

    .info-card .route-name {
      font-size: 14px;
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 8px;
    }

    .route-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #6b7280;
    }

    .btn {
      width: 100%;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-primary {
      background: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background: #2563eb;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .directions-step {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .directions-step:last-child {
      border-bottom: none;
    }

    .step-instruction {
      color: #1f2937;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .step-distance {
      color: #6b7280;
      font-size: 12px;
    }

    .hospital-section h2 {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .hospital-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .hospital-card {
      padding: 12px;
      border-radius: 8px;
      border: 2px solid #e5e7eb;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
    }

    .hospital-card:hover {
      border-color: #3b82f6;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .hospital-card.selected {
      border-color: #3b82f6;
      background: #eff6ff;
    }

    .hospital-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 4px;
    }

    .hospital-name {
      font-weight: 500;
      color: #1f2937;
      font-size: 14px;
    }

    .hospital-distance {
      font-size: 12px;
      font-weight: 600;
      color: #3b82f6;
    }

    .hospital-address {
      font-size: 12px;
      color: #6b7280;
    }

    .map-container {
      flex: 1;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .icon {
      width: 20px;
      height: 20px;
      stroke: currentColor;
      fill: none;
      stroke-width: 2;
    }

    .hidden {
      display: none;
    }

    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 12px;
      border-radius: 8px;
      font-size: 12px;
      margin-top: 8px;
    }

    .contact-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      margin-bottom: 6px;
      font-size: 13px;
    }

    .contact-number {
      font-weight: 500;
      color: #1f2937;
    }

    .contact-label {
      font-size: 11px;
      color: #6b7280;
      margin-left: 8px;
    }

    .btn-delete {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-delete:hover {
      background: #dc2626;
    }

    .input-group {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .input-group input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 13px;
    }

    .input-group input:focus {
      outline: none;
      border-color: #3b82f6;
    }

    .btn-add {
      background: #10b981;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-add:hover {
      background: #059669;
    }

    @keyframes pulse {
      0%, 100% {
        box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3), 0 2px 4px rgba(0,0,0,0.3);
      }
      50% {
        box-shadow: 0 0 0 8px rgba(239, 68, 68, 0.1), 0 2px 4px rgba(0,0,0,0.3);
      }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      animation: spin 1s linear infinite;
    }

    @keyframes locationPulse {
      0%, 100% {
        box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.3);
      }
      50% {
        box-shadow: 0 0 0 8px rgba(59, 130, 246, 0.1);
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-content">
      <div class="header">
        <svg class="icon" style="color: #3b82f6;" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 6v6l4 2"></path>
        </svg>
        <h1>SmartRide Helmet</h1>
      </div>

      <div class="info-card info-card-blue" style="margin-bottom: 24px;">
        <h2>
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
          </svg>
          Emergency Contacts
        </h2>
        <div id="contactList"></div>
        <div class="input-group">
          <input type="tel" id="contactInput" placeholder="+63XXXXXXXXXX" maxlength="13">
          <button id="addContactBtn" class="btn-add">Add</button>
        </div>
      </div>

      <div class="status-section">
        <div class="status-header">
          <span class="status-label">Device Status</span>
          <span id="statusBadge" class="status-badge status-connecting">connecting...</span>
        </div>
        <div class="status-header">
          <span class="status-label">GPS Status</span>
          <span id="gpsStatusBadge" class="status-badge status-searching">
            <svg class="icon spinner" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;" viewBox="0 0 24 24">
              <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
            </svg>
            searching...
          </span>
        </div>
        <div id="errorMessage" class="error-message hidden"></div>
      </div>

      <div id="myLocationCard" class="info-card info-card-purple">
        <h2>
          <svg class="icon" viewBox="0 0 24 24">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          My Location
        </h2>
        <p id="myLatitude">Lat: --</p>
        <p id="myLongitude">Lng: --</p>
        <p id="myAccuracy">Accuracy: --</p>
        <button id="getLocationBtn" class="btn btn-primary">
          <svg class="icon" style="width: 16px; height: 16px;" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 8v8M8 12h8"></path>
          </svg>
          Get My Location
        </button>
      </div>

      <div id="locationCard" class="info-card info-card-blue">
        <h2>
          <svg class="icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
          Device Location
        </h2>
        <p id="latitude">Lat: --</p>
        <p id="longitude">Lng: --</p>
        <p id="accuracy">Accuracy: --</p>
        <p id="speed">Speed: --</p>
        <p id="distanceToDevice" style="font-weight: 600; color: #1f2937; margin-top: 4px;">Distance: --</p>
        <p id="lastUpdate">Last update: --</p>
        <button id="navigateToDeviceBtn" class="btn btn-primary hidden">
          <svg class="icon" style="width: 16px; height: 16px;" viewBox="0 0 24 24">
            <path d="M16 3h5v5M4 20L21 3"></path>
          </svg>
          Navigate to Device
        </button>
      </div>

      <div id="routeCard" class="info-card info-card-green hidden">
        <h2>
          <svg class="icon" viewBox="0 0 24 24"><path d="M16 3h5v5M4 20L21 3M21 16v5h-5M15 15l5.5 5.5M4 4l5 5"></path></svg>
          Active Route
        </h2>
        <p class="route-name" id="routeDestinationName">--</p>
        <div class="route-stats">
          <span id="routeDistance">-- km</span>
          <span id="routeDuration">-- min</span>
        </div>
        <button id="clearRouteBtn" class="btn btn-success" style="background: #ef4444; margin-top: 12px;">
          Clear Route
        </button>
        <div id="directionsContainer" style="max-height: 300px; overflow-y: auto; margin-top: 12px; border-top: 1px solid #e5e7eb; padding-top: 8px;">
        </div>
      </div>

      <div id="impactSection" class="hospital-section">
        <h2>
          <svg class="icon" style="color: #f59e0b;" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 8v4M12 16h.01"></path>
          </svg>
          Impact Detection
        </h2>
        <div id="impactList" style="font-size: 12px; color: #6b7280;">No impacts detected</div>
        <button id="exportBtn" class="btn btn-success hidden">Export Impact History</button>
      </div>

      <div id="hospitalSection" class="hospital-section hidden">
        <h2>
          <svg class="icon" style="color: #ef4444;" viewBox="0 0 24 24">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
          </svg>
          Nearby Hospitals
        </h2>
        <div id="hospitalList" class="hospital-list"></div>
      </div>
    </div>
  </div>

  <div class="map-container">
    <div id="map"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, query, limitToLast } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      databaseURL: "https://gps-tracker-bb61c-default-rtdb.asia-southeast1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    let map, markers = [], impactMarkers = [], routeLayer = null, accuracyCircle = null;
    let myAccuracyCircle = null, deviceLocation = null, myLocation = null, myLocationMarker = null;
    let nearbyHospitals = [], selectedHospital = null, impactHistory = [], watchId = null;
    let emergencyContacts = [];

    function loadContacts() {
      const saved = localStorage.getItem('emergencyContacts');
      if (saved) {
        emergencyContacts = JSON.parse(saved);
      }
      displayContacts();
    }

    function saveContacts() {
      localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
    }

    function displayContacts() {
      const list = document.getElementById('contactList');
      if (emergencyContacts.length === 0) {
        list.innerHTML = '<p style="font-size: 12px; color: #9ca3af; margin: 8px 0;">No contacts added yet</p>';
        return;
      }
      
      list.innerHTML = '';
      emergencyContacts.forEach((contact, index) => {
        const div = document.createElement('div');
        div.className = 'contact-item';
        div.innerHTML = `
          <div>
            <span class="contact-number">${contact}</span>
            <span class="contact-label">Will receive SMS alerts</span>
          </div>
          <button class="btn-delete" onclick="deleteContact(${index})">‚úï</button>
        `;
        list.appendChild(div);
      });
    }

    function addContact() {
      const input = document.getElementById('contactInput');
      let number = input.value.trim();
      
      if (!number) {
        alert('Please enter a phone number');
        return;
      }
      
      // Format validation
      if (!number.startsWith('+')) {
        if (number.startsWith('0')) {
          number = '+63' + number.substring(1);
        } else if (number.startsWith('63')) {
          number = '+' + number;
        } else {
          number = '+63' + number;
        }
      }
      
      // Check if already exists
      if (emergencyContacts.includes(number)) {
        alert('This contact already exists');
        return;
      }
      
      emergencyContacts.push(number);
      saveContacts();
      displayContacts();
      input.value = '';
      
      // Update Firebase with new contacts
      updateContactsInFirebase();
    }

    window.deleteContact = function(index) {
      if (confirm('Remove this contact?')) {
        emergencyContacts.splice(index, 1);
        saveContacts();
        displayContacts();
        updateContactsInFirebase();
      }
    }

    function updateContactsInFirebase() {
      // Send contacts to Firebase so the device can use them for SMS
      const contactsPath = "/devices/DEVICE001/emergencyContacts.json";
      const payload = JSON.stringify(emergencyContacts);
      
      fetch(`https://${firebaseHost}${contactsPath}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: payload
      }).catch(err => console.error('Error updating contacts:', err));
    }

    function initMap() {
      map = L.map('map').setView([14.5995, 120.9842], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap',
        maxZoom: 19
      }).addTo(map);
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorMessage').classList.remove('hidden');
      document.getElementById('statusBadge').textContent = 'error';
      document.getElementById('statusBadge').className = 'status-badge status-error';
    }

    function hideError() {
      document.getElementById('errorMessage').classList.add('hidden');
    }

    function updateGPSStatus(status) {
      const badge = document.getElementById('gpsStatusBadge');
      if (status === 'fixed') {
        badge.innerHTML = '‚úì GPS Fixed';
        badge.className = 'status-badge status-connected';
      } else if (status === 'searching') {
        badge.innerHTML = '<svg class="icon spinner" style="width: 12px; height: 12px; display: inline-block; vertical-align: middle;" viewBox="0 0 24 24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg> Searching...';
        badge.className = 'status-badge status-searching';
      }
    }

    function getMyLocation() {
      if (!navigator.geolocation) {
        alert('Geolocation not supported');
        return;
      }
      const btn = document.getElementById('getLocationBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg class="icon spinner" style="width: 16px; height: 16px;" viewBox="0 0 24 24"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path></svg> Getting...';

      watchId = navigator.geolocation.watchPosition(
        (position) => {
          myLocation = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy
          };
          document.getElementById('myLatitude').textContent = 'Lat: ' + myLocation.latitude.toFixed(6);
          document.getElementById('myLongitude').textContent = 'Lng: ' + myLocation.longitude.toFixed(6);
          document.getElementById('myAccuracy').textContent = 'Accuracy: ¬±' + myLocation.accuracy.toFixed(1) + 'm';
          btn.innerHTML = '‚úì Tracking';
          btn.style.background = '#10b981';
          updateMyLocationOnMap();
          if (deviceLocation) {
            updateDistanceToDevice();
            document.getElementById('navigateToDeviceBtn').classList.remove('hidden');
          }
        },
        (error) => {
          alert('Could not get location: ' + error.message);
          btn.disabled = false;
          btn.innerHTML = 'Get My Location';
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );
    }

    function updateMyLocationOnMap() {
      if (myLocationMarker) map.removeLayer(myLocationMarker);
      if (myAccuracyCircle) map.removeLayer(myAccuracyCircle);

      myAccuracyCircle = L.circle([myLocation.latitude, myLocation.longitude], {
        radius: myLocation.accuracy,
        color: '#8b5cf6',
        fillColor: '#8b5cf6',
        fillOpacity: 0.1,
        weight: 1
      }).addTo(map);

      const myIcon = L.divIcon({
        html: '<div style="background: #8b5cf6; width: 16px; height: 16px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.3), 0 2px 4px rgba(0,0,0,0.3); animation: locationPulse 2s infinite;"></div>',
        className: '',
        iconSize: [16, 16],
        iconAnchor: [8, 8]
      });

      myLocationMarker = L.marker([myLocation.latitude, myLocation.longitude], { icon: myIcon })
        .addTo(map)
        .bindPopup('üìç You are here');
    }

    function updateDistanceToDevice() {
      if (!myLocation || !deviceLocation) return;
      const distance = calculateDistance(
        myLocation.latitude, myLocation.longitude,
        deviceLocation.latitude, deviceLocation.longitude
      );
      document.getElementById('distanceToDevice').textContent = 'Distance: ' + distance.toFixed(2) + ' km';
    }

    function navigateToDevice() {
      if (!myLocation || !deviceLocation) {
        alert('Need both locations to navigate');
        return;
      }
      getDirections(myLocation, deviceLocation, 'Device Location');
    }

    function getDirections(from, to, destinationName) {
      fetch(`https://router.project-osrm.org/route/v1/driving/${from.longitude},${from.latitude};${to.longitude},${to.latitude}?overview=full&geometries=geojson&steps=true`)
        .then(response => {
          if (!response.ok) throw new Error('Route error');
          return response.json();
        })
        .then(data => {
          if (data.routes && data.routes.length > 0) {
            displayRoute(data.routes[0], destinationName);
          }
        })
        .catch(error => {
          console.error('Route error:', error);
          alert('Could not get directions');
        });
    }

    function displayRoute(route, destinationName) {
      if (routeLayer) map.removeLayer(routeLayer);

      routeLayer = L.geoJSON(route.geometry, {
        style: { color: '#3b82f6', weight: 4, opacity: 0.7 }
      }).addTo(map);

      map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });

      document.getElementById('routeCard').classList.remove('hidden');
      document.getElementById('routeDestinationName').textContent = destinationName;
      document.getElementById('routeDistance').textContent = (route.distance / 1000).toFixed(2) + ' km';
      document.getElementById('routeDuration').textContent = Math.round(route.duration / 60) + ' min';

      const directionsContainer = document.getElementById('directionsContainer');
      directionsContainer.innerHTML = '';

      if (route.legs && route.legs[0].steps) {
        route.legs[0].steps.forEach((step, index) => {
          const stepDiv = document.createElement('div');
          stepDiv.className = 'directions-step';
          const instruction = step.maneuver.instruction || 'Continue';
          stepDiv.innerHTML = `
            <div class="step-instruction">${index + 1}. ${instruction}</div>
            <div class="step-distance">${(step.distance / 1000).toFixed(2)} km</div>
          `;
          directionsContainer.appendChild(stepDiv);
        });
      }
    }

    function clearRoute() {
      if (routeLayer) {
        map.removeLayer(routeLayer);
        routeLayer = null;
      }
      document.getElementById('routeCard').classList.add('hidden');
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    function listenToFirebase() {
      const deviceRef = ref(database, 'devices/DEVICE001');
      onValue(deviceRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          hideError();
          document.getElementById('statusBadge').textContent = 'connected';
          document.getElementById('statusBadge').className = 'status-badge status-connected';
          updateGPSStatus(data.gpsStatus || 'unknown');

          if (data.latitude && data.longitude && data.latitude !== 0 && data.longitude !== 0) {
            deviceLocation = {
              latitude: data.latitude,
              longitude: data.longitude,
              accuracy: data.accuracy || 15,
              speed: data.speed || 0
            };
            document.getElementById('latitude').textContent = 'Lat: ' + deviceLocation.latitude.toFixed(6);
            document.getElementById('longitude').textContent = 'Lng: ' + deviceLocation.longitude.toFixed(6);
            document.getElementById('accuracy').textContent = 'Accuracy: ¬±' + deviceLocation.accuracy.toFixed(1) + 'm';
            document.getElementById('speed').textContent = 'Speed: ' + deviceLocation.speed.toFixed(1) + ' km/h';
            updateMap();
            if (myLocation) {
              updateDistanceToDevice();
              document.getElementById('navigateToDeviceBtn').classList.remove('hidden');
            }
            if (nearbyHospitals.length === 0) findNearbyHospitals();
          }
          document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date().toLocaleTimeString();
        } else {
          showError('No data from device');
        }
      });

      const impactsRef = query(ref(database, 'impacts'), limitToLast(10));
      let previousCount = 0;
      onValue(impactsRef, (snapshot) => {
        impactHistory = [];
        snapshot.forEach((child) => {
          const impact = child.val();
          if (impact?.latitude && impact?.longitude) {
            impactHistory.push({
              timestamp: impact.timestamp || Date.now(),
              magnitude: impact.magnitude || 0,
              latitude: impact.latitude,
              longitude: impact.longitude
            });
          }
        });
        impactHistory.sort((a, b) => b.timestamp - a.timestamp);
        updateImpactList();
        updateImpactMarkers();
        
        if (impactHistory.length > previousCount && previousCount > 0) {
          const latest = impactHistory[0];
          map.setView([latest.latitude, latest.longitude], 17, { animate: true });
          setTimeout(() => {
            if (impactMarkers[0]) impactMarkers[0].openPopup();
          }, 1500);
        }
        previousCount = impactHistory.length;
        
        if (impactHistory.length > 0) {
          document.getElementById('exportBtn').classList.remove('hidden');
        }
      });
    }

    function updateMap() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      if (accuracyCircle) map.removeLayer(accuracyCircle);

      accuracyCircle = L.circle([deviceLocation.latitude, deviceLocation.longitude], {
        radius: deviceLocation.accuracy,
        color: '#3b82f6',
        fillColor: '#3b82f6',
        fillOpacity: 0.1,
        weight: 1
      }).addTo(map);

      const icon = L.divIcon({
        html: '<div style="background: #3b82f6; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
        className: '',
        iconSize: [20, 20],
        iconAnchor: [10, 10]
      });

      const marker = L.marker([deviceLocation.latitude, deviceLocation.longitude], { icon })
        .addTo(map)
        .bindPopup('üì± Your Device');
      markers.push(marker);
      
      if (myLocation) {
        const bounds = L.latLngBounds([
          [myLocation.latitude, myLocation.longitude],
          [deviceLocation.latitude, deviceLocation.longitude]
        ]);
        map.fitBounds(bounds, { padding: [50, 50] });
      } else {
        map.setView([deviceLocation.latitude, deviceLocation.longitude], 15);
      }
    }

    function updateImpactMarkers() {
      impactMarkers.forEach(m => map.removeLayer(m));
      impactMarkers = [];
      impactHistory.forEach(impact => {
        if (impact.latitude !== 0 && impact.longitude !== 0) {
          const icon = L.divIcon({
            html: '<div style="background: #ef4444; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.3), 0 2px 4px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>',
            className: '',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          });
          
          const popupContent = document.createElement('div');
          popupContent.innerHTML = 
            '<strong style="color: #ef4444;">‚ö†Ô∏è Impact Detected</strong><br>' +
            'Magnitude: ' + impact.magnitude.toFixed(2) + ' g<br>' +
            'Time: ' + new Date(impact.timestamp).toLocaleString() + '<br>' +
            'Location: ' + impact.latitude.toFixed(6) + ', ' + impact.longitude.toFixed(6);
          
          if (myLocation) {
            const navBtn = document.createElement('button');
            navBtn.textContent = 'üß≠ Navigate Here';
            navBtn.style.cssText = 'margin-top: 8px; padding: 6px 12px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; width: 100%;';
            navBtn.onclick = () => {
              getDirections(
                myLocation, 
                { latitude: impact.latitude, longitude: impact.longitude }, 
                'Impact Location (' + new Date(impact.timestamp).toLocaleTimeString() + ')'
              );
            };
            popupContent.appendChild(navBtn);
          } else {
            const info = document.createElement('p');
            info.style.cssText = 'margin-top: 8px; font-size: 11px; color: #6b7280;';
            info.textContent = 'üìç Click "Get My Location" to enable navigation';
            popupContent.appendChild(info);
          }
          
          const marker = L.marker([impact.latitude, impact.longitude], { icon })
            .addTo(map)
            .bindPopup(popupContent);
          impactMarkers.push(marker);
        }
      });
    }

    function updateImpactList() {
      const list = document.getElementById('impactList');
      if (impactHistory.length === 0) {
        list.innerHTML = '<p style="color: #9ca3af;">No impacts detected</p>';
        return;
      }
      list.innerHTML = '';
      impactHistory.slice(0, 5).forEach(impact => {
        const div = document.createElement('div');
        div.className = 'impact-alert';
        div.innerHTML = 
          '<div class="impact-alert-header">‚ö†Ô∏è Impact: ' + impact.magnitude.toFixed(2) + ' g</div>' +
          '<div class="impact-alert-details">' + new Date(impact.timestamp).toLocaleString() + '</div>';
        div.onclick = () => {
          if (impact.latitude !== 0 && impact.longitude !== 0) {
            map.setView([impact.latitude, impact.longitude], 16);
            if (myLocation) {
              if (confirm('Navigate to this impact location?')) {
                getDirections(
                  myLocation, 
                  { latitude: impact.latitude, longitude: impact.longitude }, 
                  'Impact Location'
                );
              }
            }
          }
        };
        list.appendChild(div);
      });
    }

    function findNearbyHospitals() {
      if (!deviceLocation) return;
      const radius = 5000;
      const query = '[out:json][timeout:25];(node["amenity"="hospital"](around:' + radius + ',' + deviceLocation.latitude + ',' + deviceLocation.longitude + ');way["amenity"="hospital"](around:' + radius + ',' + deviceLocation.latitude + ',' + deviceLocation.longitude + '););out center;';
      
      fetch('https://overpass-api.de/api/interpreter?data=' + encodeURIComponent(query))
        .then(response => response.json())
        .then(data => {
          const hospitals = [];
          data.elements.forEach(element => {
            const lat = element.lat || (element.center ? element.center.lat : null);
            const lon = element.lon || (element.center ? element.center.lon : null);
            if (!lat || !lon) return;
            const distance = calculateDistance(deviceLocation.latitude, deviceLocation.longitude, lat, lon);
            hospitals.push({
              id: element.id,
              name: element.tags.name || 'Unnamed Hospital',
              latitude: lat,
              longitude: lon,
              distance: distance,
              address: element.tags['addr:full'] || element.tags['addr:street'] || 'Address not available'
            });
          });
          hospitals.sort((a, b) => a.distance - b.distance);
          nearbyHospitals = hospitals.slice(0, 5);
          if (nearbyHospitals.length > 0) displayHospitals();
        })
        .catch(error => console.error('Error fetching hospitals:', error));
    }

    function displayHospitals() {
      document.getElementById('hospitalSection').classList.remove('hidden');
      const list = document.getElementById('hospitalList');
      list.innerHTML = '';

      nearbyHospitals.forEach(hospital => {
        const card = document.createElement('div');
        card.className = 'hospital-card';
        if (selectedHospital && selectedHospital.id === hospital.id) {
          card.className += ' selected';
        }
        card.innerHTML = 
          '<div class="hospital-header"><span class="hospital-name">' + hospital.name + '</span><span class="hospital-distance">' + hospital.distance.toFixed(2) + ' km</span></div>' +
          '<p class="hospital-address">' + hospital.address + '</p>';
        card.onclick = () => selectHospital(hospital);
        list.appendChild(card);

        const icon = L.divIcon({
          html: '<div style="background: #ef4444; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>',
          className: '',
          iconSize: [16, 16],
          iconAnchor: [8, 8]
        });

        const marker = L.marker([hospital.latitude, hospital.longitude], { icon })
          .addTo(map)
          .bindPopup('<strong>' + hospital.name + '</strong><br>' + hospital.distance.toFixed(2) + ' km away');
        markers.push(marker);
      });
    }

    function selectHospital(hospital) {
      selectedHospital = hospital;
      const cards = document.querySelectorAll('.hospital-card');
      cards.forEach(card => card.classList.remove('selected'));
      const index = nearbyHospitals.findIndex(h => h.id === hospital.id);
      if (index >= 0) cards[index].classList.add('selected');

      if (myLocation) {
        getDirections(myLocation, hospital, hospital.name);
      } else if (deviceLocation) {
        getDirections(deviceLocation, hospital, hospital.name);
      }
    }

    document.getElementById('getLocationBtn').addEventListener('click', getMyLocation);
    document.getElementById('navigateToDeviceBtn').addEventListener('click', navigateToDevice);
    document.getElementById('clearRouteBtn').addEventListener('click', clearRoute);
    document.getElementById('addContactBtn').addEventListener('click', addContact);
    
    document.getElementById('contactInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') addContact();
    });

    document.getElementById('exportBtn').addEventListener('click', () => {
      if (impactHistory.length === 0) {
        alert('No impact data to export');
        return;
      }
      let csvContent = 'Timestamp,Magnitude (g),Latitude,Longitude\n';
      impactHistory.forEach(impact => {
        const date = new Date(impact.timestamp);
        csvContent += date.toISOString() + ',' +
                      impact.magnitude.toFixed(3) + ',' +
                      impact.latitude.toFixed(6) + ',' +
                      impact.longitude.toFixed(6) + '\n';
      });
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'impact_history_' + Date.now() + '.csv');
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    window.addEventListener('load', () => {
      initMap();
      listenToFirebase();
      loadContacts();
    });
  </script>
</body>
</html>